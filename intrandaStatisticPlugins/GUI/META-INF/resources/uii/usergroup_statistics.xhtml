<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:composite="http://xmlns.jcp.org/jsf/composite" xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:x="http://myfaces.apache.org/tomahawk" xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites" xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

    <composite:interface>
    </composite:interface>

    <composite:implementation>

        <script src="template/js/plugins/flot/jquery.flot.js"></script>
        <script src="template/js/plugins/flot/jquery.flot.bar.order.min.js"></script>
        <script src="template/js/plugins/flot/jquery.flot.pie.min.js"></script>
        <script src="template/js/plugins/flot/jquery.flot.resize.min.js"></script>
        <script src="template/js/plugins/flot/jquery.flot.stack.js"></script>
        <script src="template/js/plugins/flot/jquery.flot.JUMlib.js"></script>
        <script src="template/js/plugins/flot/jquery.flot.spider.js"></script>

        <h:form id="statisticplugin" rendered="#{NavigationForm.aktuell == 'a41'}">
            <div class="row">
                <div class="col-sm-12">


                    <span>
                        <h:outputText id="uaid2" value="#{msgs.defineStatisticalQuestion}" />
                    </span>
                </div>
            </div>


            <div class="row">
                <div class="control-group">
                    <div class="controls">
                        <x:commandButton id="myStatisticButton" title="#{msgs.calculateStatistics}" value="#{msgs.calculateStatistics}" action="#{StatisticalQuestionBean.calculate}" styleClass="btn btn-primary">

                            <f:ajax execute="@form" render="@form"></f:ajax>
                        </x:commandButton>
                    </div>
                </div>
            </div>

            <h:inputText value="#{StatisticalQuestionBean.data}" id="datafield" style="display:none" />


            <div class="col-sm-7">
                <div id="placeholder" class='flot'></div>
            </div>
            <div class="col-sm-5">
                <table>
                    <ui:repeat var="datarow" value="#{StatisticalQuestionBean.currentPlugin.dataList}">
                        <tr>
                            <td>
                                <h:outputText value="#{datarow.label}" />
                            </td>
                            <td>
                                <h:outputText value="#{datarow.data}" />
                            </td>
                        </tr>
                    </ui:repeat>
                </table>
                <br />
                <h:commandLink action="#{StatisticalQuestionBean.currentPlugin.createExcelFile}" rendered="#{StatisticalQuestionBean.data != null}">
                    <h:outputText value="#{msgs.downloadExcel}" />
                </h:commandLink>
                <br />
                <h:commandLink action="#{StatisticalQuestionBean.currentPlugin.createPdfFile}" rendered="#{StatisticalQuestionBean.data != null}">
                    <h:outputText value="#{msgs.createPdfFile}" />
                </h:commandLink>


            </div>
        </h:form>


        <script type="text/javascript">
									function plotTable() {
										var data = $
												.parseJSON(document
														.getElementById('statisticplugin:datafield').value);
										function plotWithOptions() {

											$.plot('#placeholder', data, {
												series : {
													pie : {
														show : true,
														label : {
															show : true,
														}
													}
												},
												grid : {
													hoverable : true,
													clickable : true
												}
											});

										}
										plotWithOptions();
									}

									$("#placeholder")
											.on(
													'plotclick',
													function(e, pos, obj) {
														var div = '<div class="chart-info">'
																+ obj.series.label
																+ ': '
																+ obj.series.data[0][1]
																+ '</div>';
														if ($('.chart-info').length > 0) {
															$('.chart-info')
																	.remove();
														}
														$('body').append(div);
														$('.chart-info')
																.hide()
																.css(
																		{
																			'position' : 'absolute',
																			'top' : pos.pageY,
																			'left' : pos.pageX
																		})
																.show();
													});

									// AJAX Eventlistener
									jsf.ajax.addOnEvent(function(data) {
										var ajaxstatus = data.status; // Can be "begin", "complete" and "success"

										switch (ajaxstatus) {
										case "begin": // This is called right before ajax request is been sent.
											break;

										case "complete": // This is called right after ajax response is received.
											break;

										case "success": // This is called when ajax response is successfully processed.
											plotTable();
											break;
										}
									});
								</script>



    </composite:implementation>

</ui:composition>


